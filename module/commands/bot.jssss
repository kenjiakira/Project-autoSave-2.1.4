const axios = require("axios");
const moment = require("moment-timezone");
const fs = require("fs");
const path = require("path");

const openAIHistory = {};

module.exports.config = {
  name: "bot",
  version: "1.0.7",
  hasPermssion: 0,
  credits: "Akira",
  description: "BaÌ‰n nÃ¢ng cÃ¢Ìp hÆ¡n so vÆ¡Ìi GOð†ðð“\nð¥ð®Ì› ð²Ì: cáº§n nháº­p token Ä‘á»ƒ sá»­ dá»¥ng",
  commandCategory: "chatbot",
  usePrefix: false,
  usages: "\n\nCHAT VÆ ÌI GPT:\n\nSá»­ dá»¥ng lá»‡nh: .gpt [ná»™i dung]\nThay [ná»™i dung] báº±ng cÃ¢u há»i hoáº·c ná»™i dung báº¡n muá»‘n gá»­i cho GPT.\nBot sáº½ tráº£ lá»i báº¡n dá»±a trÃªn ná»™i dung báº¡n gá»­i.\n\nXOÌA LIÌ£CH SÆ¯Ì‰ CHAT GPT:\n\nSá»­ dá»¥ng lá»‡nh: .gpt clear\nBot sáº½ xÃ³a lá»‹ch sá»­ chat cá»§a báº¡n vá»›i GPT.\n\nHIÃŠÌ‰N THIÌ£ LIÌ£CH SÆ¯Ì‰ CHAT GPT:\n\nSá»­ dá»¥ng lá»‡nh: .gpt history\nBot sáº½ hiá»ƒn thá»‹ lá»‹ch sá»­ chat cá»§a báº¡n vá»›i GPT.\n\nTIÃŠÌP TUÌ£C CUÃ”Ì£C TROÌ€ CHUYÃŠÌ£N TRÆ¯Æ ÌC ÄOÌ:\n\nSá»­ dá»¥ng lá»‡nh: .gpt continue\nBot sáº½ tiáº¿p tá»¥c cuá»™c trÃ² chuyá»‡n báº¡n Ä‘Ã£ cÃ³ trÆ°á»›c Ä‘Ã³ vá»›i GPT mÃ  khÃ´ng cáº§n pháº£i gÃµ láº¡i cÃ¢u há»i.",
  cooldowns: 0,
  dependencies: {}
};

function getApiKey() {
  const apiPath = path.join(__dirname, '../../includes/handle/api.json');
  const apiData = JSON.parse(fs.readFileSync(apiPath, 'utf8'));
  return apiData.apiKey;
}

const apiKey = getApiKey();

async function getUserName(api, senderID) {
  try {
    const userInfo = await api.getUserInfo(senderID);
    return userInfo[senderID].name;
  } catch (error) {
    console.log(error);
    return "User";
  }
}

async function askGpt(conversation) {
  const url = "https://api.openai.com/v1/chat/completions";
  const response = await axios({
    url,
    method: "POST",
    headers: {
      "Authorization": `Bearer ${apiKey}`,
      "Content-Type": "application/json"
    },
    data: {
      model: "gpt-3.5-turbo",
      messages: conversation,
      max_tokens: 2028,
      temperature: 0.7
    }
  });
  return response;
}

module.exports.run = async function ({ api, event, args, Users, Threads }) {
  api.setMessageReaction("â³", event.messageID, (err) => {}, true);
  api.sendTypingIndicator(event.threadID, true);

  const senderID = event.senderID;
  const threadID = event.threadID;

  const data = `User: ${args.join(" ")}`;

  if (args.length < 1) {
    api.sendMessage("Xin chÃ o! Báº¡n cáº§n tÃ´i há»— trá»£ gÃ¬ khÃ´ng?", threadID);
    api.setMessageReaction("âœ…", event.messageID, (err) => {}, true);
    return;
  }

  switch (args[0]) {
    case "clear":
      openAIHistory[senderID] = [];
      api.sendMessage("ÄÃ£ xÃ³a lá»‹ch sá»­ chat vá»›i bot GPT.", threadID);
      break;
    case "history":
      const conversationHistory = openAIHistory[senderID];
      if (conversationHistory && conversationHistory.length > 0) {
        const formattedHistory = conversationHistory.map(
          message => message.content
        );
        api.sendMessage(
          `Lá»‹ch sá»­ chat:\n${formattedHistory.join("\n")}`,
          threadID
        );
      } else {
        api.sendMessage("Lá»‹ch sá»­ chat trá»‘ng.", threadID);
      }
      break;
    case "continue":
      const lastMessage = openAIHistory[senderID]?.pop();
      if (lastMessage) {
        const response = await askGpt(openAIHistory[senderID]);
        const message = response.data.choices[0].message.content;

        openAIHistory[senderID].push(lastMessage); // Restore the last message
        openAIHistory[senderID].push({ role: "assistant", content: message });

        api.setMessageReaction("âœ…", event.messageID, (err) => {}, true);
        api.sendMessage(message, threadID, event.messageID);
      } else {
        api.sendMessage("KhÃ´ng tÃ¬m tháº¥y tin nháº¯n trÆ°á»›c Ä‘á»ƒ tiáº¿p tá»¥c.", threadID);
      }
      break;
    default:
      openAIHistory[senderID] = openAIHistory[senderID] || [];
      openAIHistory[senderID].push({ role: "user", content: data });

      try {
        const response = await askGpt(openAIHistory[senderID]);
        const message = response.data.choices[0].message.content;

        openAIHistory[senderID].push({ role: "assistant", content: message });

        api.setMessageReaction("âœ…", event.messageID, (err) => {}, true);
        api.sendMessage(message, threadID, event.messageID);
      } catch (error) {
        if (error.response) {
          console.log(error.response.status);
          console.log(error.response.data);
        } else {
          console.log(error.message);
          api.sendMessage(error.message, threadID);
        }
      }
      break;
  }
};
